# CacheProcessor

## Требования к окружению

- Java 21
- Доступ к Maven Repository

## Описание процессора аннотации

Плагин позволяет закешировать результат работы функции, которая имеет 1 входной аргумент и возвращает не пустое 
значение, для быстрого получения результата повторного вызова функции. Для использования во многопоточном коде 
установите параметр `isThreadSafe` равным `true`.

## Сборка

Следующей командой будет произведена сборка и помещение артефакта в локальный репозиторий Maven:

```shell
mvn clean install
```

## Использование процессора аннотаций

### Подключение к проекту

В файле pom.xml подключить плагин можно следующим кодом:

```xml
<build>
    <plugins>
        ...
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <version>3.13.0</version>
            <configuration>
                <source>21</source>
                <target>21</target>
                <annotationProcessorPaths>
                    <path>
                        <groupId>ro.al.vi</groupId>
                        <artifactId>my-cacheable-processor</artifactId>
                        <version>1.0-SNAPSHOT</version>
                    </path>
                </annotationProcessorPaths>
            </configuration>
        </plugin>
        ...
    </plugins>
</build>
```

### Использование аннотации

Для использования кэша при вызове метода необходимо аннотировать метод с одним входным аргументом аннотацией 
`@MyCacheable`, пример:

```java
public class CalcService {

    @MyCacheable
    public Integer getFactorial(Integer i) {
        if (i <= 1) {
            return 1;
        }
        return i * getFactorial(i - 1);
    }
}
```

### Генерация кода плагином

Затем вызвать следующей командой процессор аннотаций для генерации кода:

```shell
mvn clean package
```

После выполнения команды выше в папке `target/generated-sources/cacheable` появится класс сгенерированный плагином:

```java
@Generated(
        value = {"MyCache version:1.0-SNAPSHOT"},
        date = "2024-11-27T18:20:17.834+0500",
        comments = "This class is generated by CacheProcessor"
)
public class MyCacheableCalcService extends CalcService {

    private static final Map<Integer, Integer> GET_FACTORIAL_CACHE_MAP = new HashMap<Integer, Integer>();

    @Override
    public Integer getFactorial(Integer i) {
        if (GET_FACTORIAL_CACHE_MAP.containsKey(i)) {
            return GET_FACTORIAL_CACHE_MAP.get(i);
        }
        Integer result = super.getFactorial(i);
        GET_FACTORIAL_CACHE_MAP.put(i, result);
        return result;
    }
}
```

Папку со сгенерированным кодом необходимо пометить как папку `Generated sources root`.

### Использование сгенерированного кода

```java
public class CacheApplication {

    private final CalcService calcService = new MyCacheableCalcService();

    public static void main(String[] args) {
        Integer key = 10;
        long start = System.nanoTime();
        Integer value = calcService.getFactorial(key);
        long end = System.nanoTime();
        System.out.println("EXAMPLE #1: " + (end - start) + " ns calc: key = " + key + ", value = " + value);

        start = System.nanoTime();
        value = calcService.getFactorial(key);
        end = System.nanoTime();
        System.out.println("EXAMPLE #2: " + (end - start) + " ns calc: key = " + key + ", value = " + value);
    }
}
```

## Ссылки

- Статья по использованию процессора аннотаций в Java [1](http://hannesdorfmann.com/annotation-processing/annotationprocessing101/), 
[2](https://www.baeldung.com/java-annotation-processing-builder);
- Генерация кода классов с помощью JavaPoet [1](https://www.baeldung.com/java-poet);
- GitHub репозиторий JavaPoet [1](https://github.com/square/javapoet);
- Генерация генерик-кода с помощью JavaPoet [1](https://stackoverflow.com/questions/30969986/javapoet-add-generic-parameter),
[2](https://stackoverflow.com/questions/40509818/how-to-generate-symbol-class-with-javapoet);
- Генерация `extends`, `implements` с помощью JavaPoet [1](https://stackoverflow.com/questions/34715266/javapoet-how-to-implement-extends-and-implements);
- Сравнение типов с помощью JavaPoet [1](https://stackoverflow.com/questions/14730223/how-to-find-return-type-of-a-method-in-java);
- Использование лямбды в JavaPoet [1](https://github.com/square/javapoet/issues/711#issuecomment-635199648).